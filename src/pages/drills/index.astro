---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { CATEGORIES, categoryLabel } from "../../lib/categories";

const selected = Astro.url.searchParams.get("cat") ?? "all";

const drills = await getCollection("drills");

const normalized = drills
  .map((d) => ({
    ...d,
    primary: d.data.primary_category ?? d.data.categories[0],
  }))
  .sort((a, b) => a.data.title.localeCompare(b.data.title));

const filtered =
  selected === "all"
    ? normalized
    : normalized.filter((d) => d.data.categories.includes(selected as any));

const countBy = (slug: string) =>
  normalized.filter((d) => d.data.categories.includes(slug as any)).length;

const toggleLink = (slug: string) => {
  if (selected === slug) return `${Astro.base}drills/`;
  return `${Astro.base}drills/?cat=${encodeURIComponent(slug)}`;
};
---
<BaseLayout title="Drills â€” Hockey Drills">
  <div class="card">
    <h1 class="h1">Drills</h1>
    <p class="sub">
      Filter by a single category. ({filtered.length} shown{selected !== "all" ? ` in ${categoryLabel(selected)}` : ""})
    </p>

    <div class="chips" role="tablist" aria-label="Category filter">
      <a
        class={`chip ${selected === "all" ? "active" : ""}`}
        href={`${Astro.base}drills/`}
        aria-current={selected === "all" ? "page" : undefined}
      >
        All <span style="opacity:.8">({normalized.length})</span>
      </a>

      {CATEGORIES.map((c) => (
        <a
          class={`chip ${selected === c.slug ? "active" : ""}`}
          href={toggleLink(c.slug)}
          aria-current={selected === c.slug ? "page" : undefined}
        >
          {c.label} <span style="opacity:.8">({countBy(c.slug)})</span>
        </a>
      ))}
    </div>
  </div>

  <div style="height: 12px;"></div>

  <div class="list">
    {filtered.map((d) => {
      const meta: string[] = [];
      if (d.data.level) meta.push(d.data.level);
      if (d.data.time_minutes) meta.push(`${d.data.time_minutes} min`);
      if (d.data.group_size) meta.push(d.data.group_size);
      meta.push(categoryLabel(d.primary));

      return (
        <a class="card" href={`${Astro.base}drills/${d.slug}/`} style="text-decoration:none;">
          <h3 class="drill-title">{d.data.title}</h3>
          <p class="sub" style="margin-top:6px;">{d.data.summary}</p>
          <div class="meta">
            {meta.map((m) => <span class="pill">{m}</span>)}
          </div>
        </a>
      );
    })}
  </div>
</BaseLayout>
